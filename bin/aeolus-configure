#!/bin/sh
usage()
{
cat << EOF

USAGE:
aeolus-configure [-d|--debug] [-h|--help] [-v|--verbose] [-i|--interactive] [-p|--profile]

OPTIONS:
   -h | --help       Show this message.
   -d | --debug      Debug logging mode.
   -v | --verbose    Verbose logging mode.
   -i | --interactive Interactive installer.
   -p | --profile    Name of profile to use
EOF
}

args=`getopt -o :hdvip: --long help,debug,verbose,interactive,profile: -- "$@"`
if test $? != 0
     then
         usage
         exit 1
fi

INTERACTIVE=1

PUPPET_NODE='configure'

eval set -- $args
while true ; do
        case "$1" in
                -h|--help) usage ; exit 1 ;  shift ;;
                -d|--debug) LOGLEVEL="--debug" ; shift ;;
                -v|--verbose) LOGLEVEL="--verbose" ; shift  ;;
                -i|--interactive) INTERACTIVE=0 ; shift  ;;
                -p|--profile) PUPPET_NODE=$2 ; shift ; shift ;;
                --) shift ; break ;;
                *)  usage ; exit 1 ;;
        esac
done

if [[ $INTERACTIVE -eq 0 ]] ; then
PUPPET_NODE='custom'
/usr/bin/ruby /usr/share/aeolus-configure/modules/aeolus/cli.rb
if [ $? == 1 ] ; then
echo
exit
fi
fi

echo "Launching aeolus configuration recipe..."

export FACTER_AEOLUS_ENABLE_HTTPS=true
export FACTER_AEOLUS_ENABLE_SECURITY=false
puppet /usr/share/aeolus-configure/modules/aeolus/aeolus.pp \
       --modulepath=/usr/share/aeolus-configure/modules/ \
       --external_nodes "/usr/sbin/aeolus-node $PUPPET_NODE" --node_terminus exec \
       --logdest=/var/log/aeolus-configure/aeolus-configure.log \
       --logdest=console \
       $LOGLEVEL
